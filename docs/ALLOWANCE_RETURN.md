針對您的需求，處理「銷貨退回/折讓」與「進貨退出/折讓」是營業稅申報演算法中非常關鍵的一環。這些數據在 **.TXT（明細檔）** 中是獨立的交易記錄，而在 **.TET\_U（申報書檔）** 中則必須被彙總到專屬的「減項」欄位。

以下根據《營業稅電子資料申報繳稅作業要點》及《軟體使用手冊》整理的分析與演算法邏輯：

---

### **第一部分：營業人進銷項資料檔 (.TXT) 的處理邏輯**

在 `.TXT` 檔中，退回與折讓被視為一種特殊的「憑證格式」，每一張折讓單都需要記錄。

#### **1\. 關鍵判斷欄位 (Key Fields)**

要識別並處理退回折讓，您的演算法必須過濾以下欄位：

* **格式代號 (A, 第 1-2 碼)**：這是最核心的區分依據。  
* **課稅別 (P, 第 62 碼)**：區分應稅、零稅率或免稅。  
* **扣抵代號 (R, 第 73 碼)**：僅用於進項，區分是「進貨費用」還是「固定資產」。  
* **通關方式 (T, 第 81 碼)**：僅用於銷項零稅率。

#### **2\. 退回與折讓的 .TXT 記錄規則表**

| 交易類型 | 格式代號 (A) | 欄位定義與邏輯 | 備註 |
| ----- | ----- | ----- | ----- |
| **銷項**(銷貨退回/折讓) | **33** | 三聯式、電子計算機、三聯式收銀機及一般稅額電子發票之證明單。 | 需逐筆登錄。 |
| **銷項**(銷貨退回/折讓) | **34** | 二聯式、二聯式收銀機及免用統一發票之證明單。 | 需逐筆登錄。 |
| **銷項**(特種稅額退回) | **38** | 特種稅額之銷貨退回或折讓證明單。 | 需逐筆登錄。 |
| **進項**(進貨退出/折讓) | **23** | 三聯式、電子計算機、三聯式收銀機及一般稅額電子發票之證明單。 | 需逐筆登錄。 |
| **進項**(進貨退出/折讓) | **24** | 二聯式收銀機及其他憑證之證明單。 | 需逐筆登錄。 |
| **進項**(海關退還) | **29** | 海關退還溢繳營業稅申報單。 | 視同進項之負項。 |

**演算法更新重點：** 在生成 `.TXT` 時，請確保這些格式代號 (33, 34, 38, 23, 24, 29\) 的金額 (**O 欄**) 與稅額 (**Q 欄**) 填寫的是 **證明單上的正數金額**（即折讓了多少錢），而不是負數。

---

### **第二部分：營業人銷售額與稅額申報書檔 (.TET\_U) 的處理邏輯**

在 `.TET_U` 檔中，退回與折讓有**專屬的欄位**。您的程式必須將上述 `.TXT` 中的記錄，依照屬性分類加總，填入這些專屬欄位。

**注意：** 申報書中的「銷售額合計」與「進項稅額合計」公式會自動將這些欄位作為 **減項** 處理。

#### **1\. 銷項退回與折讓的彙總邏輯 (Output Returns)**

| 條件篩選 (來自 .TXT) | .TET\_U 目標欄位 (112欄格式) | 處理邏輯 |
| ----- | ----- | ----- |
| **應稅銷項折讓**格式代號: **33, 34**課稅別: **1 (應稅)** | **13** (退回及折讓金額)**19** (退回及折讓稅額) | 將所有符合條件的 `.TXT` 記錄之 **O (金額)** 加總填入欄位 13；**Q (稅額)** 加總填入欄位 19。 |
| **零稅率折讓**格式代號: **33, 34**課稅別: **2 (零稅率)** | **24** (零稅率退回及折讓) | 將所有符合條件的 `.TXT` 記錄之 **O (金額)** 加總填入欄位 24。\*(註：不分經海關/非經海關，統一填此欄)\* |
| **免稅折讓**格式代號: **33, 34**課稅別: **3 (免稅)** | **30** (免稅退回及折讓) | 將所有符合條件的 `.TXT` 記錄之 **O (金額)** 加總填入欄位 30。 |
| **特種稅額折讓**格式代號: **38** | **43** (特種銷售額退回)**44** (特種稅額退回) | 將所有符合條件的 `.TXT` 記錄之 **O (金額)** 加總填入欄位 43；**Q (稅額)** 加總填入欄位 44。 |

**計算影響：**

* 應稅銷售額合計 (.TET\_U 欄位 14\) \= (9+10+11+12) \- **13**  
* 應稅稅額合計 (.TET\_U 欄位 20\) \= (15+16+17+18) \- **19**  
* 零稅率銷售額合計 (.TET\_U 欄位 25\) \= (22+23) \- **24**

---

#### **2\. 進項退出與折讓的彙總邏輯 (Input Returns)**

進項折讓必須區分是「進貨費用」還是「固定資產」，這取決於 `.TXT` 中的 **扣抵代號 (R)**。

| 條件篩選 (來自 .TXT) | .TET\_U 目標欄位 (112欄格式) | 處理邏輯 |
| ----- | ----- | ----- |
| **一般進貨退出**格式代號: **23, 24**扣抵代號: **1 (進貨費用)** | **56** (退出及折讓金額)**66** (退出及折讓稅額) | 將符合條件之 **O (金額)** 加總填入欄位 56；**Q (稅額)** 加總填入欄位 66。 |
| **固定資產退出**格式代號: **23, 24**扣抵代號: **2 (固定資產)** | **57** (退出及折讓金額)**67** (退出及折讓稅額) | 將符合條件之 **O (金額)** 加總填入欄位 57；**Q (稅額)** 加總填入欄位 67。 |
| **海關退還**格式代號: **29** | *(特殊處理)* | 通常海關退還會直接減少海關代徵欄位 (74, 75, 78, 79\) 的數值，或依稽徵機關指導填寫。但在標準申報書格式中，主要依靠 23/24 格式處理一般折讓。 |

**計算影響：**

* 進貨及費用稅額合計 (.TET\_U 欄位 68\) \= (60+62+64) \- **66**  
* 固定資產稅額合計 (.TET\_U 欄位 69\) \= (61+63+65) \- **67**

---

### **第三部分：演算法更新摘要 (Algorithm Update Summary)**

為了讓您的程式正確處理退回與折讓，請在計算 `.TET_U` 參數時加入以下邏輯分支：

1. **遍歷 .TXT 資料時：**

   * **IF** 格式代號 IN ('33', '34', '38', '23', '24')：  
     * 標記此筆為「折讓/退回」。  
     * **注意：** 雖然這是「減項」，但在 `.TXT` 檔案中金額欄位 (O, Q) 仍應寫入 **正數 (Absolute Value)**。  
2. **彙總至 .TET\_U 時：**

   * **不要**將這些格式代號的金額加到一般的銷售額欄位（如欄位 9 三聯式發票）。  
   * **必須**將它們獨立累加到對應的「退回及折讓」欄位（如欄位 13）。  
   * **計算合計欄位 (如欄位 14, 20, 68\) 時：** 執行減法運算：`合計 = (一般發票加總) - (退回折讓加總)`。  
3. **檢核邏輯 (Validation)：**

   * `.TET_U` 中的退回金額與稅額，必須嚴格等於 `.TXT` 中對應格式代號記錄的總和，否則 **勾稽審核 (Cross-check)** 會失敗。

**範例代碼概念 (虛擬碼)：**

```
# 初始化 TET_U 欄位
TET_U_Field_9 = 0  # 銷項三聯式
TET_U_Field_13 = 0 # 銷項退回

for record in TXT_Records:
    amount = record.SalesAmount
    format_code = record.FormatCode

    # 銷項處理
    if format_code == '31': # 三聯式發票
        TET_U_Field_9 += amount
    elif format_code == '33': # 三聯式退回折讓
        # 這是關鍵：不扣減 Field 9，而是累積到 Field 13
        TET_U_Field_13 += amount

# 最後計算 TET_U 的合計欄位 (Field 14)
TET_U_Field_14 = TET_U_Field_9 + (其他銷項) - TET_U_Field_13
```

依據此邏輯更新您的演算法，即可確保 `.TXT` 與 `.TET_U` 在處理退回折讓時的數據一致性與合規性。

其中專門針對 **401 申報書（專營應稅營業人）**，分析 **.TXT（明細）** 與 **.TET\_U（申報書）** 之間的數據流向與計算邏輯。

此分析特別強化了「退回與折讓」的處理邏輯，您可以直接將此邏輯應用於您的程式演算法中。

---

### **核心概念：資料流向**

1. **來源**：`.TXT` 檔案（每一筆交易的原始憑證，包含正向交易與負向折讓）。  
2. **處理**：程式需遍歷 `.TXT`，依據「格式代號」、「課稅別」、「扣抵代號」進行分類累加。  
3. **目的**：`.TET_U` 檔案（填入分類累加後的總額，並執行最終稅額計算）。

---

### **第一部分：銷項邏輯 (Output Sales) \- 寫入 .TET\_U 欄位 9\~25**

針對 401 申報書，銷項分為「應稅」與「零稅率」。**注意：在 401 表格中，免稅 (P=3) 與特種稅額 (格式 37, 38\) 通常不應存在或金額應為 0。**

#### **1\. 應稅銷項 (Taxable Sales)**

* **篩選條件**：`.TXT` 中 **課稅別 (P) \= '1'** (應稅)。

| .TXT 來源 (格式代號 A) | .TET\_U 對應欄位 (金額 / 稅額) | 處理邏輯 (累加) |
| ----- | ----- | ----- |
| **31** (三聯式/電子計算機) | **9** (金額) / **15** (稅額) | 累加 `O` 至欄位 9，累加 `Q` 至欄位 15。 |
| **35** (三聯式收銀機/電子) | **10** (金額) / **16** (稅額) | 累加 `O` 至欄位 10，累加 `Q` 至欄位 16。 |
| **32** (二聯式/二聯式收銀機) | **11** (金額) / **17** (稅額) | 累加 `O` 至欄位 11，累加 `Q` 至欄位 17。 |
| **36** (免用發票) | **12** (金額) / **18** (稅額) | 累加 `O` 至欄位 12，累加 `Q` 至欄位 18。 |

#### **2\. 銷項退回與折讓 (Sales Returns & Allowances)**

* **關鍵邏輯**：`.TXT` 中折讓單金額為正數，程式需將其累加至 `.TET_U` 的專屬折讓欄位。  
* **篩選條件**：`.TXT` 格式代號為 **33** 或 **34**。

| .TXT 來源 (格式代號 A) | 課稅別 (P) | .TET\_U 對應欄位 | 處理邏輯 |
| ----- | ----- | ----- | ----- |
| **33, 34** | **1** (應稅) | **13** (金額) / **19** (稅額) | 累加 `O` 至欄位 13，累加 `Q` 至欄位 19。 |
| **33, 34** | **2** (零稅率) | **24** (金額) | 累加 `O` 至欄位 24 (零稅率折讓不分通關方式)。 |

#### **3\. 零稅率銷項 (Zero-Tax Sales)**

* **篩選條件**：`.TXT` 中 **課稅別 (P) \= '2'** (零稅率)。

| .TXT 來源 (通關方式 T) | .TET\_U 對應欄位 (金額) | 處理邏輯 |
| ----- | ----- | ----- |
| **1** (非經海關) | **22** | 累加 `O` 至欄位 22。需與 `.T02` 檔勾稽。 |
| **2** (經海關) | **23** | 累加 `O` 至欄位 23。 |

#### **4\. 銷項彙總計算 (由程式計算填入 .TET\_U)**

* **欄位 14 (應稅銷售額合計)** \= (9 \+ 10 \+ 11 \+ 12\) \- **13**  
* **欄位 20 (應稅稅額合計)** \= (15 \+ 16 \+ 17 \+ 18\) \- **19** *(此值將帶入欄位 82\)*  
* **欄位 25 (零稅率銷售額合計)** \= (22 \+ 23\) \- **24** *(此值用於計算退稅限額)*  
* **欄位 47 (銷售額總計)** \= 14 \+ 25

---

### **第二部分：進項邏輯 (Input Purchases) \- 寫入 .TET\_U 欄位 50\~71**

針對 401 申報書，進項重點在於區分\*\*「進貨費用」**與**「固定資產」\*\*。

* **關鍵篩選**：`.TXT` 中的 **扣抵代號 (R)**。  
  * **R=1**：進貨及費用 (對應 .TET\_U 偶數欄位，如 50, 60)。  
  * **R=2**：固定資產 (對應 .TET\_U 奇數欄位，如 51, 61)。

#### **1\. 進項憑證 (Purchases)**

| .TXT 來源 (格式代號 A) | R 代號 | .TET\_U 對應欄位 (金額 / 稅額) | 處理邏輯 |
| ----- | ----- | ----- | ----- |
| **21, 26** (三聯式) | 1 | **50 / 60** | 累加 `O` 至 50，`Q` 至 60。 |
|  | 2 | **51 / 61** | 累加 `O` 至 51，`Q` 至 61。 |
| **25** (三聯收銀/電子) | 1 | **52 / 62** | 累加 `O` 至 52，`Q` 至 62。 |
|  | 2 | **53 / 63** | 累加 `O` 至 53，`Q` 至 63。 |
| **22, 27** (其他憑證) | 1 | **54 / 64** | 累加 `O` 至 54，`Q` 至 64。 |
|  | 2 | **55 / 65** | 累加 `O` 至 55，`Q` 至 65。 |
| **28** (海關代徵) | 1 | **74 / 78** | 累加 `N`(稅基) 至 74，`Q` 至 78。 |
|  | 2 | **75 / 79** | 累加 `N`(稅基) 至 75，`Q` 至 79。 |

#### **2\. 進項退出與折讓 (Purchase Returns & Allowances)**

* **關鍵邏輯**：`.TXT` 中格式 **23, 24** 代表折讓。

| .TXT 來源 (格式代號 A) | R 代號 | .TET\_U 對應欄位 (金額 / 稅額) | 處理邏輯 |
| ----- | ----- | ----- | ----- |
| **23, 24** | 1 | **56 / 66** (進貨退出) | 累加 `O` 至 56，`Q` 至 66。 |
| **23, 24** | 2 | **57 / 67** (固定資產退出) | 累加 `O` 至 57，`Q` 至 67。 |

#### **3\. 進項彙總計算 (由程式計算填入 .TET\_U)**

* **欄位 58 (進貨費用金額合計)** \= (50 \+ 52 \+ 54\) \- **56**  
* **欄位 59 (固定資產金額合計)** \= (51 \+ 53 \+ 55\) \- **57**  
* **欄位 68 (進貨費用稅額合計)** \= (60 \+ 62 \+ 64\) \- **66**  
* **欄位 69 (固定資產稅額合計)** \= (61 \+ 63 \+ 65\) \- **67** *(注意：計算退稅限額時會用到此欄 \+ 海關固定資產稅額 79\)*

---

### **第三部分：最終稅額計算 (Tax Calculation) \- 寫入 .TET\_U 欄位 82\~95**

這部分完全依賴上述彙總欄位進行計算，不直接讀取 `.TXT`。

| .TET\_U 欄位 | 欄位名稱 | 計算公式 / 來源 |
| ----- | ----- | ----- |
| **82** | 本期銷項稅額合計 | \= 欄位 **20** (應稅稅額合計)。 |
| **86** | 小計 (銷項) | \= 82 \+ 83(國外勞務) \+ 84(特種) \+ 85(調整)。*(401通常只有 82\)* |
| **87** | 得扣抵進項稅額合計 | \= **68** (進貨費用稅額) \+ **69** (固定資產稅額) \+ **78** (海關進貨稅額) \+ **79** (海關固資稅額)。 |
| **88** | 上期累積留抵稅額 | **\[需外部參數\]** 從資料庫或上期申報書讀取。 |
| **90** | 小計 (進項+留抵) | \= 87 \+ 88 \+ 89(調整退稅)。 |
| **91** | 本期應實繳稅額 | \= (86 \- 90)。若結果 **\> 0** 則填入，否則填 0。 |
| **92** | 本期申報留抵稅額 | \= (90 \- 86)。若結果 **\> 0** 則填入，否則填 0。*(與 91 互斥)* |
| **93** | 得退稅限額 | \= (欄位 **25** × 5%) \+ (欄位 **69** \+ 欄位 **79**)。*(零稅率銷售 × 5% \+ 固定資產進項稅額)* |
| **94** | 本期應退稅額 | 若 (92 \> 0)，則取 **min(92, 93\)**。*(留抵稅額與退稅限額取小者)* |
| **95** | 本期累積留抵稅額 | \= 92 \- 94。*(剩餘未退的留抵稅額，留待下期)* |

### **程式實作檢查清單 (Checklist for 401\)**

1. **初始化**：將 `.TET_U` 所有金額欄位設為 0。  
2. **遍歷 .TXT**：  
   * 如果是 **格式 33, 34** (銷項折讓) $\\rightarrow$ 加到 **折讓欄位** (13, 19, 24)。  
   * 如果是 **格式 23, 24** (進項折讓) $\\rightarrow$ 加到 **折讓欄位** (56, 66, 57, 67)。  
   * 其他格式 \--\> 加到 **一般欄位**。  
   * **注意**：所有金額在累加時都取正值，**減法運算**只發生在計算「合計欄位」時。  
3. **計算合計**：執行上述的加減法公式 (例如 14 \= ... \- 13)。  
4. **填入稅額計算區**：執行 82\~95 的邏輯。  
5. **輸出**：產生以 `|` 分隔的 `.TET_U` 文字檔。

這套邏輯完全符合 等來源中關於 401 申報書的規範。

