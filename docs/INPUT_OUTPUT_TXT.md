### **演算法：營業人進銷項資料檔（.TXT）製作流程（修正版）**

**目標：** 彙整所有交易記錄，並依序寫入 `統一編號.TXT` 文件中。每筆記錄長度嚴格為 **81 Byte**。數字型態欄位（如金額、稅額）不足位數，應在**左邊補零**。

#### **步驟一：記錄基礎欄位（Byte 1-39）**

| 欄位代號 | 欄位名稱 | 長度 (Bytes) | 位置 (起始-結束) | 製作及判斷邏輯 |
| ----- | ----- | ----- | ----- | ----- |
| **A** | 格式代號 | 2 | 1-2 | **必要輸入**。進項 (21-29) 或銷項 (31-38)。詳見下方格式代號對照表。 |
| **B** | 申報營業人稅籍編號 | 9 | 3-11 | 9 位數字，需符合稅籍編號邏輯檢查。 |
| **C** | 流水號 | 7 | 12-18 | 7 位文數字，按順序編列，不可重複。 |
| **D** | 資料所屬年月 | 5 | 19-23 | 國曆年（3 位）+ 月（2 位）。進項可追溯近十年，銷項通常為當期所屬期。 |
| **E/F** | 買受人統編 / 發票訖號 | 8 | 24-31 | **欄位連動檢查 (S)**：1. 若 **S \= A** 且為**銷項憑證**：此欄為**發票訖號**（8 位數字）。2. 否則 (S \= B 或 空白)：此欄為**買受人統一編號**。3. 買受人無統編則**全部補空白**。 |
| **G/H** | 銷售人統編 / 彙總張數 | 8 | 32-39 | **欄位連動檢查 (S)**：1. 若 **S \= A** 且為**進項憑證**：前 4 位 (32-35) 代表**彙總張數**（需大於 1）。2. 否則 (S \= B 或 空白)：此欄為**銷售人統一編號**。3. 格式代號 28 (海關代徵) 或 29 (海關退還)，此欄為銷售人統編。 |

#### **格式代號 (A) 對照表**

| 格式代號 | 發票/憑證類型 | 文件類型 | 進項/銷項 | 說明 |
|----------|--------------|----------|----------|------|
| **21** | 手開三聯式 | 發票 | 進項 | 三聯式統一發票、電子計算機發票 |
| **22** | 手開二聯式 | 發票 | 進項 | 二聯式統一發票 |
| **23** | 電子發票折讓 | **折讓** | 進項 | 三聯式/電子發票之進貨退出或折讓證明單 |
| **24** | 二聯式折讓 | **折讓** | 進項 | 二聯式收銀機及其他憑證之折讓證明單 |
| **25** | 電子發票 | 發票 | 進項 | 三聯式收銀機發票、電子發票 |
| **26** | — | 發票 | 進項 | 彙總登錄每張稅額五百元以下之三聯式 |
| **27** | — | 發票 | 進項 | 彙總登錄每張稅額五百元以下之二聯式 |
| **28** | 海關代徵 | 發票 | 進項 | 海關代徵營業稅繳納證 |
| **29** | 海關退還 | **折讓** | 進項 | 海關退還溢繳營業稅申報單 |
| **31** | 手開三聯式 | 發票 | 銷項 | 三聯式統一發票、電子計算機發票 |
| **32** | 手開二聯式 | 發票 | 銷項 | 二聯式統一發票、二聯式收銀機發票 |
| **33** | 電子發票折讓 | **折讓** | 銷項 | 三聯式/電子發票之銷貨退回或折讓證明單 |
| **34** | 二聯式折讓 | **折讓** | 銷項 | 二聯式/免用發票之銷貨退回或折讓證明單 |
| **35** | 電子發票 | 發票 | 銷項 | 三聯式收銀機發票、電子發票 |
| **36** | 免用發票 | 發票 | 銷項 | 免用統一發票 |
| **37** | 特種稅額 | 發票 | 銷項 | 特種稅額計算之銷售額 |
| **38** | 特種稅額折讓 | **折讓** | 銷項 | 特種稅額之銷貨退回或折讓證明單 |

**注意：** 折讓/退回格式代號 (23, 24, 29 進項；33, 34, 38 銷項) 的詳細處理邏輯，請參閱 `ALLOWANCE_RETURN.md`。

#### **步驟二：憑證號碼共用區塊（Byte 36-49）— 互斥邏輯（I, J, K, L, M）**

此區塊（36-49）是整個演算法的核心修正點。必須根據**格式代號 (A)** 選擇以下四種憑證資訊結構之一填寫，並確保只有一組資料佔用位置：

| 欄位代號 | 欄位名稱 | 長度 (Bytes) | 範圍 (起始-結束) | 製作及判斷邏輯 |
| ----- | ----- | ----- | ----- | ----- |
| **M** | **海關代徵營業稅繳納證號碼** | 14 | **36-49** | **使用條件：** 僅限格式代號 **28** (代徵繳納證) 或 **29** (退還溢繳申報單)。**邏輯：** 若使用 M，則 I, J, K, L 欄位**全部無效**（被 M 覆蓋）。 |
| **I \+ J** | **發票字軌 \+ 發票(起)號碼** | 10 | **40-49** | **使用條件：** 適用標準統一發票（如 21, 31, 35）及多數退折讓單。1. I. 字軌 (40-41)：2 位文字。2. J. 號碼 (42-49)：8 位數字。**邏輯：** 若使用 I \+ J，則 K, L, M 欄位**必須無效**。 |
| **K** | **其他憑證號碼** | 10 | **40-49** | **使用條件：** 進項憑證格式 22, 24, 27；銷項憑證格式 34, 36, 37, 38。**邏輯：** 與 I \+ J 互斥。若使用 K，則 I, J, L, M 欄位**必須無效**。 |
| **L** | **公用事業載具流水號** | 10 | **40-49** | **使用條件：** 僅限格式代號 **25** (進項三聯式收銀機發票) 且使用載具流水號替代發票號碼時。**邏輯：** L 替代 I \+ J 或 K。前 2 碼固定為 **BB**。 |

**註：** 欄位 36-39 (長度 4 Bytes) 的空間，當 **M 欄位不使用時**，由 **G/H 欄位** 的**彙總張數**（32-35）+ **空白**（36-39）或者 **銷售人統編**（32-39）使用。

#### **步驟三：金額與稅務代號欄位（Byte 50-81）**

| 欄位代號 | 欄位名稱 | 長度 (Bytes) | 位置 (起始-結束) | 製作及判斷邏輯 |
| ----- | ----- | ----- | ----- | ----- |
| **O / N** | 銷售額 / 營業稅稅基 | 12 | 50-61 | **共用欄位**。1. 若為**海關憑證 (28, 29\)**：填入 **N. 營業稅稅基**。2. 否則：填入 **O. 銷售額**。**要求：** 必須為 12 位數字（以元為單位），**左邊補零**。銷售金額**不可為空白**。 |
| **P** | 課稅別 | 1 | 62-62 | 代號區分：1 (應稅)、2 (零稅率)、3 (免稅)。**F** (作廢發票) 或 **D** (空白未使用發票) 時，除少數欄位外，其他欄位以**空白或零補足**長度。 |
| **Q** | 營業稅額 | 10 | 63-72 | **必要輸入**。10 位數字，**左邊補零**。若銷售額已含稅（如銷項對非營業人發票，或二聯式進項），本欄應以**零**表示。 |
| **R** | 扣抵代號 | 1 | 73-73 | 僅用於**進項憑證**。代號區分：1 (進貨及費用可扣抵)、2 (固定資產可扣抵)、3 (不可扣抵費用)、4 (不可扣抵固定資產)。銷項為**空白**。 |
| **空白** | (特種稅率前空白) | 5 | 74-78 | 保留欄位，填**空白**。 |
| **特種稅額稅率** | 1 | 79-79 | **僅用於銷項特種稅額憑證 (37, 38\)**。代號 1-7。其他為**空白**。 |  |
| **S** | 彙加註記或分攤註記 | 1 | 80-80 | 1\. **A**：彙加資料（彙總登錄）。2. **B**：進項憑證**分攤資料**，僅限格式代號 **25** 使用，且不適用彙總登錄。3. **空白**：非彙加資料（逐筆登錄）。 |
| **T** | 通關方式註記 | 1 | 81-81 | **僅用於銷項零稅率 (P=2)**。代號：1 (非經海關)、2 (經海關)。其他為**空白**。 |

### **範例**

#### **昂工科技的 60707504.TXT 進銷項資料檔**

`213514060820000001114096070750416160426RT26980200000000000107100000000051`          
`253514060820000002114096070750488232292TJ78038974000000000095100000000051`          
`313514060820000003114098500152160707504RT3366245000000000600010000000300`           
`31351406082000000411409        60707504RT33662451000000000000F0000000000`           
`313514060820000005114099355669160707504RT3366245200000000600010000000300`           
`313514060820000006114098253032360707504RT3366245300000012000010000006000`           
`313514060820000007114098253032360707504RT3366245400000000500010000000250`           
`313514060820000008114109355669160707504RT3366245500000000600010000000300`           
`313514060820000009114108253032360707504RT3366245600000000500010000000250`           
`313514060820000010114093366249960707504RT33662457000000000000D0000000000       A`   
`323514060820000011114092577669960707504RV25776650000000000000D0000000000       A` 

